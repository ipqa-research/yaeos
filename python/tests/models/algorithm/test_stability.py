import numpy as np

import yaeos


def test_this_stability_should_work():
    tcs = [
        694.26,
        631.54436074476,
        730.15,
        647.13,
        653.0,
        687.7,
        751.13,
        653.0,
        782.3143974343982,
    ]

    pcs = [
        27.79,
        26.3960195207736,
        217.0,
        220.55,
        28.2,
        29.4408,
        33.6454,
        28.2,
        38.72293315376218,
    ]

    ws = [
        0.770625,
        0.906135886637798,
        0.358233,
        0.344861,
        0.380863,
        0.365434205640836,
        0.423686802561004,
        0.380863,
        2.09000834791546,
    ]

    c1 = [
        1.60513,
        1.81245,
        1.06615,
        1.0783,
        1.11438,
        1.06539497171316,
        1.12138149980366,
        1.11438,
        3.39522544430089,
    ]

    c2 = [
        -0.21195,
        -0.06092,
        -0.39235,
        -0.58321,
        -0.62643,
        -0.371283736082231,
        -0.110512464728183,
        -0.62643,
        -0.568922582090522,
    ]

    c3 = [
        1.15479,
        1.71043,
        0.27125,
        0.54619,
        1.06066,
        0.756295830742416,
        0.172293209520844,
        1.06066,
        3.30936527469462,
    ]

    molecules = [
        {1: 1, 2: 6, 42: 1},
        {1: 1, 2: 5, 22: 1, 14: 1},
        {14: 2},
        {16: 1},
        {1: 2, 2: 3, 3: 1, 7: 1, 8: 1},
        {1: 2, 2: 3, 3: 1, 7: 1, 138: 1},
        {1: 2, 2: 3, 3: 1, 138: 1, 140: 1},
        {1: 2, 2: 3, 3: 1, 7: 1, 8: 1},
        {1: 2, 2: 4, 3: 2, 4: 2, 14: 4},
    ]

    model = yaeos.PSRK(
        critical_temperatures=tcs,
        critical_pressures=pcs,
        acentric_factors=ws,
        molecules=molecules,
        c1=c1,
        c2=c2,
        c3=c3,
    )

    n = np.array(
        [
            0.0109332222922422,
            0.0016872617241227,
            0.0208208957389066,
            0.4098252653859982,
            3.93932491909656e-16,
            8.067032840600871e-07,
            0.0005039799071726,
            0.0030866916244586,
            0.0272754380096706,
        ]
    )

    z = n / np.sum(n)

    t = 45 + 273.15

    p = 1.01325

    stb = model.stability_analysis(z, p, t)

    # Minimum
    tm_min = stb[0]["tm"]
    w_min = stb[0]["w"]

    w_min_expected = np.array(
        [
            3.30846987e-02,
            8.32731035e-04,
            8.67542972e-06,
            5.06134743e-03,
            1.20597867e-13,
            1.09860811e-04,
            1.59470771e-02,
            9.44954866e-01,
            7.43137792e-07,
        ]
    )

    assert np.isclose(tm_min, -1.926589802101753, atol=1e-7)
    assert np.allclose(w_min, w_min_expected, atol=1e-7)

    # the other minimum
    for idx, tm in enumerate(stb[1]["tm"]):
        if not np.isclose(tm, tm_min):
            other_tm = tm
            other_w = stb[1]["w"][idx]
            break

    assert np.isclose(other_tm, -0.035518756956091746, atol=1e-7)

    other_w_expected = np.array(
        [
            0.0008897519951867498,
            0.00016864023770985244,
            0.0450127154834326,
            0.9517216638538627,
            1.166305451932275e-17,
            2.7538682081212242e-08,
            2.2438780734232182e-05,
            9.138685800168516e-05,
            0.00209337525239002,
        ]
    )

    assert np.allclose(other_w, other_w_expected, atol=1e-7)
